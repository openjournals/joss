<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE article PUBLIC "-//NLM//DTD JATS (Z39.96) Journal Publishing DTD v1.2 20190208//EN"
                  "JATS-publishing1.dtd">
<article xmlns:mml="http://www.w3.org/1998/Math/MathML" xmlns:xlink="http://www.w3.org/1999/xlink" dtd-version="1.2" article-type="other">
<front>
<journal-meta>
<journal-id></journal-id>
<journal-title-group>
<journal-title>Journal of Open Source Software</journal-title>
<abbrev-journal-title>JOSS</abbrev-journal-title>
</journal-title-group>
<issn publication-format="electronic">2475-9066</issn>
<publisher>
<publisher-name>Open Journals</publisher-name>
</publisher>
</journal-meta>
<article-meta>
<article-id pub-id-type="publisher-id">2373</article-id>
<article-id pub-id-type="doi">10.21105/joss.02373</article-id>
<title-group>
<article-title>MetalWalls: A classical molecular dynamics software
dedicated to the simulation of electrochemical systems</article-title>
</title-group>
<contrib-group>
<contrib contrib-type="author">
<string-name>Abel Marin-Laflèche</string-name>
<xref ref-type="aff" rid="aff-1"/>
</contrib>
<contrib contrib-type="author">
<string-name>Matthieu Haefele</string-name>
<xref ref-type="aff" rid="aff-1"/>
</contrib>
<contrib contrib-type="author">
<string-name>Laura Scalfi</string-name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<string-name>Alessandro Coretti</string-name>
<xref ref-type="aff" rid="aff-3"/>
<xref ref-type="aff" rid="aff-4"/>
</contrib>
<contrib contrib-type="author">
<string-name>Thomas Dufils</string-name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<string-name>Guillaume Jeanmairet</string-name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<string-name>Stewart K. Reed</string-name>
<xref ref-type="aff" rid="aff-5"/>
</contrib>
<contrib contrib-type="author">
<string-name>Alessandra Serva</string-name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<string-name>Roxanne Berthin</string-name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<string-name>Camille Bacon</string-name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<string-name>Sara Bonella</string-name>
<xref ref-type="aff" rid="aff-4"/>
</contrib>
<contrib contrib-type="author">
<string-name>Benjamin Rotenberg</string-name>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<contrib contrib-type="author">
<string-name>Paul A. Madden</string-name>
<xref ref-type="aff" rid="aff-6"/>
</contrib>
<contrib contrib-type="author">
<string-name>Mathieu Salanne</string-name>
<xref ref-type="aff" rid="aff-1"/>
<xref ref-type="aff" rid="aff-2"/>
</contrib>
<aff id="aff-1">
<institution-wrap>
<institution>Maison de la Simulation, CEA, CNRS, Univ. Paris-Sud, UVSQ,
Université Paris-Saclay, F-91191 Gif-sur-Yvette, France</institution>
</institution-wrap>
</aff>
<aff id="aff-2">
<institution-wrap>
<institution>Sorbonne Université, CNRS, Physico-chimie des Électrolytes
et Nanosystèmes Interfaciaux, PHENIX, F-75005 Paris,
France</institution>
</institution-wrap>
</aff>
<aff id="aff-3">
<institution-wrap>
<institution>Department of Mathematical Sciences, Politecnico di Torino,
I-10129 Torino, Italy</institution>
</institution-wrap>
</aff>
<aff id="aff-4">
<institution-wrap>
<institution>Centre Européen de Calcul Atomique et Moléculaire (CECAM),
École Polytechnique Fédérale de Lausanne, 1015 Lausanne,
Switzerland</institution>
</institution-wrap>
</aff>
<aff id="aff-5">
<institution-wrap>
<institution>School of Chemistry, University of Leeds, Leeds,
UK</institution>
</institution-wrap>
</aff>
<aff id="aff-6">
<institution-wrap>
<institution>Department of Materials, University of Oxford, Oxford,
UK</institution>
</institution-wrap>
</aff>
</contrib-group>
<pub-date date-type="pub" publication-format="electronic" iso-8601-date="2020-05-28">
<day>28</day>
<month>5</month>
<year>2020</year>
</pub-date>
<volume>5</volume>
<issue>53</issue>
<fpage>2373</fpage>
<permissions>
<copyright-statement>Authors of papers retain copyright and release the
work under a Creative Commons Attribution 4.0 International License (CC
BY 4.0)</copyright-statement>
<copyright-year>2021</copyright-year>
<copyright-holder>The article authors</copyright-holder>
<license license-type="open-access" xlink:href="https://creativecommons.org/licenses/by/4.0/">
<license-p>Authors of papers retain copyright and release the work under
a Creative Commons Attribution 4.0 International License (CC BY
4.0)</license-p>
</license>
</permissions>
<kwd-group kwd-group-type="author">
<kwd>Fortran</kwd>
<kwd>molecular dynamics</kwd>
<kwd>electrodes</kwd>
<kwd>ionic liquids</kwd>
</kwd-group>
</article-meta>
</front>
<body>
<sec id="summary">
  <title>Summary</title>
  <p>Applied electrochemistry plays a key role in many technologies,
  such as Li-ion batteries, fuel cells, supercapacitors, solar cells,
  etc. It is therefore at the core of many research programs all over
  the world. However, fundamental electrochemical investigations remain
  scarce. In particular, electrochemistry is among the fields for which
  the gap between theory and experiment is the largest. From the
  computational point of view, there is no classical molecular dynamics
  (MD) software devoted to the simulation of electrochemical systems
  while other fields such as biochemistry or material science have
  dedicated tools. <monospace>MetalWalls</monospace>, a MD code
  dedicated to electrochemistry, fills this gap. Its main originality is
  the inclusion of a series of methods which allow a constant electrical
  potential to be applied to the electrode materials. It also allows the
  simulation of bulk liquids or solids using the polarizable ion model
  and the aspherical ion model. <monospace>MetalWalls</monospace> is
  designed to be used on high-performance computers and it has already
  been employed in a number of scientific publications. It was for
  example used to study the charging mechanism of supercapacitors
  (<xref alt="Merlet et al., 2012" rid="ref-MerletU003A2012" ref-type="bibr">Merlet
  et al., 2012</xref>), nanoelectrowetting
  (<xref alt="Choudhuri et al., 2016" rid="ref-ChoudhuriU003A2016" ref-type="bibr">Choudhuri
  et al., 2016</xref>) and water desalination devices
  (<xref alt="Simoncelli et al., 2018" rid="ref-SimoncelliU003A2018" ref-type="bibr">Simoncelli
  et al., 2018</xref>). A typical snapshot of a simulation cell for the
  latter is shown on
  <xref alt="Figure 1" rid="figU003Asnapshot">Figure 1</xref>.</p>
  <fig>
    <caption><p>Typical system simulated using
    <monospace>MetalWalls</monospace>. An aqueous NaCl electrolyte is
    put in contact with two electrified nanoporous carbon electrodes
    (left: positive electrode, right: negative electrode). Water
    molecules are in red and white, Cl<inline-formula><alternatives>
    <tex-math><![CDATA[^-]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msup><mml:mi></mml:mi><mml:mo>−</mml:mo></mml:msup></mml:math></alternatives></inline-formula>
    ions in cyan, Na<inline-formula><alternatives>
    <tex-math><![CDATA[^+]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msup><mml:mi></mml:mi><mml:mo>+</mml:mo></mml:msup></mml:math></alternatives></inline-formula>
    ions in green and the carbon atoms are colored according to their
    charge (from light grey to black when the charge increases).
    <styled-content id="figU003Asnapshot"></styled-content></p></caption>
    <graphic mimetype="image" mime-subtype="png" xlink:href="black3.png" xlink:title="" />
  </fig>
</sec>
<sec id="constant-potential-electrodes">
  <title>Constant potential electrodes</title>
  <p><monospace>MetalWalls</monospace> employs most of the standard
  methods and algorithms available in typical MD packages. Here we
  discuss only its main originality, which lies in the possibility of
  simulating materials at constant electric potential instead of
  constant charge. This is interesting for simulating conductors where
  the charges are not fixed on the atoms but can spread in the material
  and adapt to the external medium. In
  <monospace>MetalWalls</monospace>, this is done by allowing the charge
  on the material atoms to fluctuate under the condition of constant
  potential. The method was first introduced by Siepmann and Sprik
  (<xref alt="Siepmann &amp; Sprik, 1995" rid="ref-SiepmannU003A1995" ref-type="bibr">Siepmann
  &amp; Sprik, 1995</xref>). It was later adapted to the case of 2D
  periodic boundary conditions and extended to a Born-Oppenheimer-like
  approach in the first version of <monospace>MetalWalls</monospace>
  (<xref alt="Reed et al., 2007" rid="ref-ReedU003A2007" ref-type="bibr">Reed
  et al., 2007</xref>). The method was also discussed in the framework
  of Mass-Zero (MaZe) constrained molecular dynamics in
  (<xref alt="Coretti et al., 2020" rid="ref-CorettiU003A2020" ref-type="bibr">Coretti
  et al., 2020</xref>). An updated description of the statistical
  mechanics of the constant potential ensemble can be found in the
  reference
  (<xref alt="Scalfi et al., 2020" rid="ref-ScalfiU003A2020" ref-type="bibr">Scalfi
  et al., 2020</xref>).</p>
  <p>Two different models are employed for the charge distributions of
  the electrode and electrolyte atoms constituting the electrochemical
  cell. On the one hand, electrode atoms carry a Gaussian charge
  distribution of amplitude <inline-formula><alternatives>
  <tex-math><![CDATA[Q_i]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
  and width <inline-formula><alternatives>
  <tex-math><![CDATA[\eta_i^{-1}]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msubsup><mml:mi>η</mml:mi><mml:mi>i</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msubsup></mml:math></alternatives></inline-formula></p>
  <p><disp-formula><alternatives>
  <tex-math><![CDATA[\rho_i (\mathbf{r}) = Q_i \eta_i^3 \pi ^{-3/2} \exp(-\eta_i^2 |\mathbf{r} - \mathbf{R}_i|^2)]]></tex-math>
  <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:msub><mml:mi>ρ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msubsup><mml:mi>η</mml:mi><mml:mi>i</mml:mi><mml:mn>3</mml:mn></mml:msubsup><mml:msup><mml:mi>π</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mn>3</mml:mn><mml:mi>/</mml:mi><mml:mn>2</mml:mn></mml:mrow></mml:msup><mml:mo>exp</mml:mo><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mo>−</mml:mo><mml:msubsup><mml:mi>η</mml:mi><mml:mi>i</mml:mi><mml:mn>2</mml:mn></mml:msubsup><mml:msup><mml:mrow><mml:mo stretchy="true" form="prefix">|</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mo>−</mml:mo><mml:msub><mml:mstyle mathvariant="bold"><mml:mi>𝐑</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="true" form="postfix">|</mml:mo></mml:mrow><mml:mn>2</mml:mn></mml:msup><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></disp-formula></p>
  <p>where <inline-formula><alternatives>
  <tex-math><![CDATA[\mathbf{R}_i]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mstyle mathvariant="bold"><mml:mi>𝐑</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
  are the electrode atoms positions.</p>
  <p>On the other hand, electrolyte atoms have a point charge
  distribution</p>
  <p><disp-formula><alternatives>
  <tex-math><![CDATA[\rho_i (\mathbf{r}) = q_i \delta (\mathbf{r} - \mathbf{r}_i)]]></tex-math>
  <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:msub><mml:mi>ρ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>q</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mi>δ</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mo>−</mml:mo><mml:msub><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></disp-formula></p>
  <p>where <inline-formula><alternatives>
  <tex-math><![CDATA[\mathbf{r}_i]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mi>i</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
  are the electrolyte atoms positions. The Coulomb potential energy for
  the full charge distribution <inline-formula><alternatives>
  <tex-math><![CDATA[\rho=\sum_i \rho_i]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mi>ρ</mml:mi><mml:mo>=</mml:mo><mml:msub><mml:mo>∑</mml:mo><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>ρ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></inline-formula>
  is given (in atomic units) by</p>
  <p><disp-formula><alternatives>
  <tex-math><![CDATA[V_c[\rho]=\frac{1}{2}\int d^3 \mathbf{r} d^3 \mathbf{r}'\frac{\rho(\mathbf{r})\rho(\mathbf{r}')}{\mid \mathbf{r}-\mathbf{r}'\mid}]]></tex-math>
  <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">[</mml:mo><mml:mi>ρ</mml:mi><mml:mo stretchy="true" form="postfix">]</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mn>2</mml:mn></mml:mfrac><mml:mo>∫</mml:mo><mml:msup><mml:mi>d</mml:mi><mml:mn>3</mml:mn></mml:msup><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:msup><mml:mi>d</mml:mi><mml:mn>3</mml:mn></mml:msup><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mi>′</mml:mi><mml:mfrac><mml:mrow><mml:mi>ρ</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow><mml:mi>ρ</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mi>′</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mo>∣</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mo>−</mml:mo><mml:mstyle mathvariant="bold"><mml:mi>𝐫</mml:mi></mml:mstyle><mml:mi>′</mml:mi><mml:mo>∣</mml:mo></mml:mrow></mml:mfrac></mml:mrow></mml:math></alternatives></disp-formula></p>
  <p>As it is long-ranged, it cannot be truncated at a cut-off distance.
  In <monospace>MetalWalls</monospace>, it is calculated using the Ewald
  summation method, whose specific expression depends on the periodicity
  (2D or 3D) of the system
  (<xref alt="Reed et al., 2007" rid="ref-ReedU003A2007" ref-type="bibr">Reed
  et al., 2007</xref>). Given the above form of the charge density, for
  fixed atomic positions it can also be expressed as a
  <inline-formula><alternatives>
  <tex-math><![CDATA[V_c(Q)]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula>,
  where <inline-formula><alternatives>
  <tex-math><![CDATA[Q]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>Q</mml:mi></mml:math></alternatives></inline-formula>
  is a vector containing all the <inline-formula><alternatives>
  <tex-math><![CDATA[N]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>N</mml:mi></mml:math></alternatives></inline-formula>
  electrode atom charges <inline-formula><alternatives>
  <tex-math><![CDATA[(Q_1,...Q_N)]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:msub><mml:mi>Q</mml:mi><mml:mn>1</mml:mn></mml:msub><mml:mo>,</mml:mo><mml:mi>.</mml:mi><mml:mi>.</mml:mi><mml:mi>.</mml:mi><mml:msub><mml:mi>Q</mml:mi><mml:mi>N</mml:mi></mml:msub><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:math></alternatives></inline-formula>.</p>
  <p>The electric potential generated by the charge distribution
  associated with an electrode atom is <inline-formula><alternatives>
  <tex-math><![CDATA[\frac{\partial V_c(Q)}{\partial Q_i}]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac></mml:math></alternatives></inline-formula>.
  It follows that the constant electric potential condition within the
  electrode materials is given by <disp-formula><alternatives>
  <tex-math><![CDATA[\frac{\partial V_c(Q)}{\partial Q_i} = \Psi_i]]></tex-math>
  <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:msub><mml:mi>Ψ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></disp-formula></p>
  <p>where <inline-formula><alternatives>
  <tex-math><![CDATA[\Psi_i]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mi>Ψ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
  is the applied potential difference on the electrode sites. This is
  equivalent to</p>
  <p><disp-formula><alternatives>
  <tex-math><![CDATA[\frac{\partial V(Q)}{\partial Q_i} = 0]]></tex-math>
  <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>V</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></alternatives></disp-formula></p>
  <p>where the total potential energy <inline-formula><alternatives>
  <tex-math><![CDATA[V(Q)]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mi>V</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></inline-formula>
  is defined as</p>
  <p><disp-formula><alternatives>
  <tex-math><![CDATA[V(Q) = V_c(Q) - \sum_{i=1}^{N}\Psi_iQ_i]]></tex-math>
  <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mi>V</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow><mml:mo>−</mml:mo><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>N</mml:mi></mml:munderover><mml:msub><mml:mi>Ψ</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></disp-formula></p>
  <p>and includes the work necessary to charge the electrodes. The
  charges <inline-formula><alternatives>
  <tex-math><![CDATA[Q]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>Q</mml:mi></mml:math></alternatives></inline-formula>
  that satisfy the constant potential condition are found by solving the
  system of <inline-formula><alternatives>
  <tex-math><![CDATA[N]]></tex-math>
  <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>N</mml:mi></mml:math></alternatives></inline-formula>
  equations given by Eq. (5).</p>
  <p>It is also frequent, in constant potential simulations, to enforce
  the so-called electroneutrality constraint, defined by the equation
  <disp-formula><alternatives>
  <tex-math><![CDATA[\sum_{i=1}^{N}Q_i = 0]]></tex-math>
  <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:munderover><mml:mo>∑</mml:mo><mml:mrow><mml:mi>i</mml:mi><mml:mo>=</mml:mo><mml:mn>1</mml:mn></mml:mrow><mml:mi>N</mml:mi></mml:munderover><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></alternatives></disp-formula></p>
  <p>As the electrolyte ions undergo thermal motion, thereby changing
  the external potential, these equations must be solved to determine
  the electrode charges consistent with the constant potential
  condition. Two methods, described below, have been applied to achieve
  this.</p>
  <sec id="born-oppenheimer-approach">
    <title>Born-Oppenheimer approach</title>
    <p>A first method to simulate the dynamics of the electrolyte atoms
    under the constant potential condition is to solve directly the
    equation <disp-formula><alternatives>
    <tex-math><![CDATA[\frac{\partial V_c(Q)}{\partial Q_i} = \Psi_i]]></tex-math>
    <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:msub><mml:mi>Ψ</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:math></alternatives></disp-formula></p>
    <p>for each electrolyte configuration. This method relies on the
    quadratic form of the Coulomb energy with respect to the electrode
    charges to solve efficiently the equation for the
    <inline-formula><alternatives>
    <tex-math><![CDATA[Q]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>Q</mml:mi></mml:math></alternatives></inline-formula>.
    In particular, <inline-formula><alternatives>
    <tex-math><![CDATA[V_c]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
    can be written in the form <disp-formula><alternatives>
    <tex-math><![CDATA[V_c(Q) = \frac{1}{2}Q^{T}AQ - Q^{T}b + c]]></tex-math>
    <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:msub><mml:mi>V</mml:mi><mml:mi>c</mml:mi></mml:msub><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow><mml:mo>=</mml:mo><mml:mfrac><mml:mn>1</mml:mn><mml:mn>2</mml:mn></mml:mfrac><mml:msup><mml:mi>Q</mml:mi><mml:mi>T</mml:mi></mml:msup><mml:mi>A</mml:mi><mml:mi>Q</mml:mi><mml:mo>−</mml:mo><mml:msup><mml:mi>Q</mml:mi><mml:mi>T</mml:mi></mml:msup><mml:mi>b</mml:mi><mml:mo>+</mml:mo><mml:mi>c</mml:mi></mml:mrow></mml:math></alternatives></disp-formula></p>
    <p>which yields a set of equations for the charges given by
    <inline-formula><alternatives>
    <tex-math><![CDATA[AQ - b = \Psi]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mi>A</mml:mi><mml:mi>Q</mml:mi><mml:mo>−</mml:mo><mml:mi>b</mml:mi><mml:mo>=</mml:mo><mml:mi>Ψ</mml:mi></mml:mrow></mml:math></alternatives></inline-formula>,
    where the matrix <inline-formula><alternatives>
    <tex-math><![CDATA[A]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>A</mml:mi></mml:math></alternatives></inline-formula>
    depends only on the geometry of the electrodes while the vector
    <inline-formula><alternatives>
    <tex-math><![CDATA[b]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>b</mml:mi></mml:math></alternatives></inline-formula>
    depends also on the positions of the electrolyte atoms
    (<inline-formula><alternatives>
    <tex-math><![CDATA[\Psi]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>Ψ</mml:mi></mml:math></alternatives></inline-formula>
    is a vector containing the <inline-formula><alternatives>
    <tex-math><![CDATA[N]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>N</mml:mi></mml:math></alternatives></inline-formula>
    electrode atom potentials (<inline-formula><alternatives>
    <tex-math><![CDATA[\Psi_1]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mi>Ψ</mml:mi><mml:mn>1</mml:mn></mml:msub></mml:math></alternatives></inline-formula>,
    …, <inline-formula><alternatives>
    <tex-math><![CDATA[\Psi_N]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mi>Ψ</mml:mi><mml:mi>N</mml:mi></mml:msub></mml:math></alternatives></inline-formula>)).
    The set of equations can then be solved by direct numerical matrix
    inversion yielding the charges</p>
    <p><disp-formula><alternatives>
    <tex-math><![CDATA[Q = A^{-1}(b+\Psi)]]></tex-math>
    <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mi>Q</mml:mi><mml:mo>=</mml:mo><mml:msup><mml:mi>A</mml:mi><mml:mrow><mml:mo>−</mml:mo><mml:mn>1</mml:mn></mml:mrow></mml:msup><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>b</mml:mi><mml:mo>+</mml:mo><mml:mi>Ψ</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow></mml:math></alternatives></disp-formula></p>
    <p>This is very efficient when the electrodes are fixed as the
    matrix <inline-formula><alternatives>
    <tex-math><![CDATA[A]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>A</mml:mi></mml:math></alternatives></inline-formula>
    is constant and the inversion has to be performed only once at the
    beginning of the simulation. <monospace>MetalWalls</monospace> also
    allows constant pressure <inline-formula><alternatives>
    <tex-math><![CDATA[P_z]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:msub><mml:mi>P</mml:mi><mml:mi>z</mml:mi></mml:msub></mml:math></alternatives></inline-formula>
    simulations to be run by treating the electrodes as rigid pistons.
    In this case, a more efficient way to solve the linear system is by
    using the conjugate gradient iterative method.</p>
    <p>The fulfillment of the electroneutrality constraint in this
    framework and its repercussions on the statistical mechanics of the
    constant-potential ensemble are discussed at length in
    (<xref alt="Scalfi et al., 2020" rid="ref-ScalfiU003A2020" ref-type="bibr">Scalfi
    et al., 2020</xref>).</p>
  </sec>
  <sec id="mass-zero-constrained-md-maze">
    <title>Mass-Zero constrained MD (MaZe)</title>
    <p>Another approach, based on the method introduced in
    (<xref alt="Coretti et al., 2018" rid="ref-CorettiU003A2018" ref-type="bibr">Coretti
    et al., 2018</xref>), is to consider the motion of the electrolyte
    particles subject to the set of holonomic constraints given by
    <disp-formula><alternatives>
    <tex-math><![CDATA[\frac{\partial V(Q)}{\partial Q_i} = 0]]></tex-math>
    <mml:math display="block" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mrow><mml:mfrac><mml:mrow><mml:mi>∂</mml:mi><mml:mi>V</mml:mi><mml:mrow><mml:mo stretchy="true" form="prefix">(</mml:mo><mml:mi>Q</mml:mi><mml:mo stretchy="true" form="postfix">)</mml:mo></mml:mrow></mml:mrow><mml:mrow><mml:mi>∂</mml:mi><mml:msub><mml:mi>Q</mml:mi><mml:mi>i</mml:mi></mml:msub></mml:mrow></mml:mfrac><mml:mo>=</mml:mo><mml:mn>0</mml:mn></mml:mrow></mml:math></alternatives></disp-formula></p>
    <p>This approach is based on an extended Lagrangian, where the
    electrode charges <inline-formula><alternatives>
    <tex-math><![CDATA[Q]]></tex-math>
    <mml:math display="inline" xmlns:mml="http://www.w3.org/1998/Math/MathML"><mml:mi>Q</mml:mi></mml:math></alternatives></inline-formula>
    are considered additional dynamical variables for the system. Unlike
    previous extended-Lagrangian approaches <italic>à la</italic> Car
    and Parrinello, the mass-zero limit is enforced rigorously in this
    method and the additional degrees of freedom are properly separated
    from the physical ones in an adiabatic sense. This yields dynamical
    equations of motion for the additional variables which can be solved
    numerically by symplectic and time-reversible algorithms, while
    keeping the adiabatic separation. In
    (<xref alt="Bonella et al., 2020" rid="ref-BonellaU003A2020" ref-type="bibr">Bonella
    et al., 2020</xref>) it has been proven that the dynamics also
    samples the Born-Oppenheimer distribution exactly. The application
    of the method to constant potential simulations is described in
    detail in
    (<xref alt="Coretti et al., 2020" rid="ref-CorettiU003A2020" ref-type="bibr">Coretti
    et al., 2020</xref>) together with the possibility of enforcing the
    electroneutrality constraint.</p>
  </sec>
  <sec id="finite-electric-field-variant">
    <title>Finite electric field variant</title>
    <p>An extension of the constant potential approach was recently
    proposed, in which the electrochemical cell is simulated by
    including one electrode only, using 3D periodic boundary conditions.
    The electrode is set at constant potential and a finite field is
    applied to the whole cell. Two electrochemical interfaces form on
    the opposite sides of the metal, and we have shown that this
    approach yields similar results to the two electrodes setup for bulk
    electrode materials
    (<xref alt="Dufils et al., 2019" rid="ref-DufilsU003A2019" ref-type="bibr">Dufils
    et al., 2019</xref>).</p>
  </sec>
</sec>
<sec id="acknowledgements">
  <title>Acknowledgements</title>
  <p>MS would like to acknowledge the support from Maison de la
  Simulation through the « Chaire d’excellence » program. This project
  has received funding from the European Research Council (ERC) under
  the European Union’s Horizon 2020 research and innovation programme
  (Grant Agreement No. 771294). This work was supported by the French
  National Research Agency (Labex STORE-EX, Grant No. ANR-10-LABX-0076).
  We acknowledge support from EoCoE, a project funded by the European
  Union Contracts No. H2020-EINFRA-2015-1-676629 and
  H2020-INFRAEDI-2018-824158.</p>
</sec>
</body>
<back>
<ref-list>
  <ref-list>
    <ref id="ref-ReedU003A2007">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Reed</surname><given-names>S. K.</given-names></name>
          <name><surname>Lanning</surname><given-names>O. J.</given-names></name>
          <name><surname>Madden</surname><given-names>P. A.</given-names></name>
        </person-group>
        <article-title>Electrochemical Interface Between an Ionic Liquid and a Model Metallic Electrode</article-title>
        <source>J. Chem. Phys.</source>
        <year iso-8601-date="2007">2007</year>
        <volume>126</volume>
        <pub-id pub-id-type="doi">10.1063/1.2464084</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-SiepmannU003A1995">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Siepmann</surname><given-names>J. I.</given-names></name>
          <name><surname>Sprik</surname><given-names>M.</given-names></name>
        </person-group>
        <article-title>Influence of Surface-Topology and Electrostatic Potential on Water Electrode Systems</article-title>
        <source>J. Chem. Phys.</source>
        <year iso-8601-date="1995">1995</year>
        <volume>102</volume>
        <pub-id pub-id-type="doi">10.1063/1.469429</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-ScalfiU003A2020">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Scalfi</surname><given-names>L.</given-names></name>
          <name><surname>Limmer</surname><given-names>D. T.</given-names></name>
          <name><surname>Coretti</surname><given-names>A.</given-names></name>
          <name><surname>Bonella</surname><given-names>S.</given-names></name>
          <name><surname>Madden</surname><given-names>P. A.</given-names></name>
          <name><surname>Salanne</surname><given-names>M.</given-names></name>
          <name><surname>Rotenberg</surname><given-names>B.</given-names></name>
        </person-group>
        <article-title>Charge fluctuations from molecular simulations in the constant-potential ensemble</article-title>
        <source>Phys. Chem. Chem. Phys.</source>
        <year iso-8601-date="2020">2020</year>
        <volume>22</volume>
        <pub-id pub-id-type="doi">10.1039/C9CP06285H</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-MerletU003A2012">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Merlet</surname><given-names>C.</given-names></name>
          <name><surname>Rotenberg</surname><given-names>B.</given-names></name>
          <name><surname>Madden</surname><given-names>P. A.</given-names></name>
          <name><surname>Taberna</surname><given-names>P.-L.</given-names></name>
          <name><surname>Simon</surname><given-names>P.</given-names></name>
          <name><surname>Gogotsi</surname><given-names>Y.</given-names></name>
          <name><surname>Salanne</surname><given-names>M.</given-names></name>
        </person-group>
        <article-title>On the Molecular Origin of Supercapacitance in Nanoporous Carbon Electrodes</article-title>
        <source>Nat. Mater.</source>
        <year iso-8601-date="2012">2012</year>
        <volume>11</volume>
        <pub-id pub-id-type="doi">10.1038/nmat3260</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-ChoudhuriU003A2016">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Choudhuri</surname><given-names>J. R.</given-names></name>
          <name><surname>Vanzo</surname><given-names>D.</given-names></name>
          <name><surname>Madden</surname><given-names>P. A.</given-names></name>
          <name><surname>Salanne</surname><given-names>M.</given-names></name>
          <name><surname>Bratko</surname><given-names>D.</given-names></name>
          <name><surname>Luzar</surname><given-names>A.</given-names></name>
        </person-group>
        <article-title>Dynamic response in nanoelectrowetting on a dielectric</article-title>
        <source>ACS Nano</source>
        <year iso-8601-date="2016">2016</year>
        <volume>10</volume>
        <pub-id pub-id-type="doi">10.1021/acsnano.6b03753.s001</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-SimoncelliU003A2018">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Simoncelli</surname><given-names>M.</given-names></name>
          <name><surname>Ganfoud</surname><given-names>N.</given-names></name>
          <name><surname>Sene</surname><given-names>A.</given-names></name>
          <name><surname>Haefele</surname><given-names>M.</given-names></name>
          <name><surname>Daffos</surname><given-names>B.</given-names></name>
          <name><surname>Taberna</surname><given-names>P.-L.</given-names></name>
          <name><surname>Salanne</surname><given-names>M.</given-names></name>
          <name><surname>Simon</surname><given-names>P.</given-names></name>
          <name><surname>Rotenberg</surname><given-names>B.</given-names></name>
        </person-group>
        <article-title>Blue energy and desalination with nanoporous carbon electrodes: Capacitance from molecular simulations to continuous models</article-title>
        <source>Phys. Rev. X</source>
        <year iso-8601-date="2018">2018</year>
        <volume>8</volume>
        <pub-id pub-id-type="doi">10.1103/physrevx.8.021024</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-CorettiU003A2018">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Coretti</surname><given-names>A.</given-names></name>
          <name><surname>Bonella</surname><given-names>S.</given-names></name>
          <name><surname>Ciccotti</surname><given-names>G.</given-names></name>
        </person-group>
        <article-title>Communication: Constrained molecular dynamics for polarizable models</article-title>
        <source>J. Chem. Phys.</source>
        <year iso-8601-date="2018">2018</year>
        <volume>149</volume>
        <pub-id pub-id-type="doi">10.1063/1.5055704</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-BonellaU003A2020">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Bonella</surname><given-names>S.</given-names></name>
          <name><surname>Coretti</surname><given-names>A.</given-names></name>
          <name><surname>Vuilleumier</surname><given-names>R.</given-names></name>
          <name><surname>Ciccotti</surname><given-names>G.</given-names></name>
        </person-group>
        <article-title>Adiabatic motion and statistical mechanics via mass zero constrained dynamics</article-title>
        <source>Phys. Chem. Chem. Phys.</source>
        <year iso-8601-date="2020">2020</year>
        <volume>22</volume>
        <pub-id pub-id-type="doi">10.1039/d0cp00163e</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-CorettiU003A2020">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Coretti</surname><given-names>A.</given-names></name>
          <name><surname>Scalfi</surname><given-names>L.</given-names></name>
          <name><surname>Bacon</surname><given-names>C.</given-names></name>
          <name><surname>Rotenberg</surname><given-names>B.</given-names></name>
          <name><surname>Vuilleumier</surname><given-names>R.</given-names></name>
          <name><surname>Ciccotti</surname><given-names>G.</given-names></name>
          <name><surname>Salanne</surname><given-names>M.</given-names></name>
          <name><surname>Bonella</surname><given-names>S.</given-names></name>
        </person-group>
        <article-title>Mass-zero constrained molecular dynamics for electrode charges in simulations of electrochemical systems</article-title>
        <source>J. Chem. Phys.</source>
        <year iso-8601-date="2020">2020</year>
        <volume>152</volume>
        <pub-id pub-id-type="doi">10.1063/5.0007192</pub-id>
      </element-citation>
    </ref>
    <ref id="ref-DufilsU003A2019">
      <element-citation publication-type="article-journal">
        <person-group person-group-type="author">
          <name><surname>Dufils</surname><given-names>T.</given-names></name>
          <name><surname>Jeanmairet</surname><given-names>G.</given-names></name>
          <name><surname>Rotenberg</surname><given-names>B.</given-names></name>
          <name><surname>Sprik</surname><given-names>M.</given-names></name>
          <name><surname>Salanne</surname><given-names>M.</given-names></name>
        </person-group>
        <article-title>Simulating electrochemical systems by combining the finite field method with a constant potential electrode</article-title>
        <source>Phys. Rev. Lett.</source>
        <year iso-8601-date="2019">2019</year>
        <volume>123</volume>
        <pub-id pub-id-type="doi">10.1103/physrevlett.123.195501</pub-id>
      </element-citation>
    </ref>
  </ref-list>
</ref-list>
</back>
</article>
