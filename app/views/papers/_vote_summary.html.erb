<div class="card">
  <div class="card-header">
  Scope summary <% if @paper.votes.any? %><small>üëç <%= @paper.votes.in_scope.count %> &middot; üëé <%= @paper.votes.out_of_scope.count %></small><% end %>
  </div>
  <div class="card-body">
    <p class="card-text">Record your opinion on whether or not this submission is in scope, leaving a comment explaining your decision for the EiCs. If you make a mistake or want to change your vote, simply fill out the form again (this will remove your first vote).</p>

    <%= form_for [@paper, Vote.new] do |f| %>
      <div class="form-group">
        <div class="row">
          <div class="col">
            <%= f.text_area :comment, class: "form-control", placeholder: "Include a comment with your vote (required)", 
                data: { paper_id: @paper.id }, id: "vote-comment" %>
          </div>
        </div>
      </div>

      <div class="form-group">
        <div class="row">
          <div class="col-md-3">
            <%= f.submit "Vote as in scope üëç", form_class: "left", class: "btn btn-light btn-sm" %>
          </div>
          <div class="col-md-3">
            <%= f.submit "Vote as out of scope üëé", form_class: "left", class: "btn btn-light btn-sm" %>
          </div>
          <div class="col-md-3">
            <%= f.submit "Just comment ü§î", form_class: "left", class: "btn btn-light btn-sm" %>
          </div>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          console.log('DOM Content Loaded - Initializing vote comment storage');
          
          const commentField = document.getElementById('vote-comment');
          console.log('Comment field found:', commentField);
          
          const paperId = commentField.dataset.paperId;
          console.log('Paper ID:', paperId);
          
          const storageKey = `vote_comment_${paperId}`;
          console.log('Storage key:', storageKey);

          // Load saved comment if it exists
          const savedComment = localStorage.getItem(storageKey);
          console.log('Saved comment from storage:', savedComment);
          
          if (savedComment) {
            commentField.value = savedComment;
            console.log('Restored comment from storage');
          }

          // Save comment on input
          commentField.addEventListener('input', function() {
            console.log('Input detected, saving comment:', this.value);
            localStorage.setItem(storageKey, this.value);
          });

          // Clear storage when form is submitted
          const form = commentField.closest('form');
          form.addEventListener('submit', function() {
            console.log('Form submitted, clearing storage');
            localStorage.removeItem(storageKey);
          });
        });
      </script>

      <div class="form-group">
        <%= link_to "View vote summary &raquo;".html_safe, "#voteSummary", class: 'tooltips', title: 'View vote summary', data: { toggle: 'collapse'} %>

        <table class="table table-sm collapse" id="voteSummary" style="margin-top:10px;">
          <thead>
            <tr>
              <th scope="col"><small><strong>Vote</strong></small></th>
              <th scope="col"><small><strong>Editor</strong></small></th>
              <th scope="col" style="width: 50%;"><small><strong>Comment</strong></small></th>
              <th scope="col"><small><strong>Time</strong></small></th>
            </tr>
          </thead>
          <tbody>
          <% @paper.votes.each do |vote| %>
          <tr>
            <td>
              <% if vote.in_scope? %>
                <small>üëç (in scope)</small>
              <% elsif vote.out_of_scope? %>
                <small>üëé (out of scope)</small>
              <% else %>
                <small>N/A (comment)</small>
              <% end %>
            </td>
            <td><small><%= vote.editor.user.name %> (<%= vote.editor.login %>)</small></td>
            <td><small><%= vote_comment_preview(vote) %></small></td>
            <td><small><%= time_ago_in_words(vote.created_at) %> ago</small></td>
          </tr>
          <% end %>
          </tbody>
        </table>

        <div class="collapse" >
          <% @paper.votes.each do |vote| %>
            <% if vote.in_scope? %>
              <small><%= vote.editor.user.name %> (<%= vote.editor.login %>) voted üëç <%= time_ago_in_words(vote.created_at) %> ago.</small>
            <% else %>
              <small><%= vote.editor.login %> voted üëé</small>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
  <div class="card-footer">
    <% if @paper.votes.any? %>
    <small class="text-muted">Last voted on <%= time_ago_in_words(@paper.votes.first.created_at) %> ago by <%= @paper.votes.first.editor.login %> </small>
    <% else %>
    <small class="text-muted">No votes on scope yet.</small>
    <% end %>
  </div>
</div>
<br />